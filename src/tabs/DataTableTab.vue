<script setup>
  import { ref, computed, defineEmits, onMounted, watch } from 'vue';
  import { useDataStore } from '@/stores/dataStore.js';

  const emit = defineEmits(['highlight-on-map']);

  const dataStore = useDataStore();

  /** üìë Áï∂Ââç‰ΩúÁî®‰∏≠ÁöÑÂúñÂ±§ÂàÜÈ†Å */
  const activeLayerTab = ref(null);
  /** üìä ÊØèÂÄãÂúñÂ±§ÁöÑÊéíÂ∫èÁãÄÊÖã */
  const layerSortStates = ref({});

  /**
   * üó∫Ô∏è ÂèØË¶ãÂúñÂ±§Ë®àÁÆóÂ±¨ÊÄß (Visible Layers Computed Property)
   * Áç≤ÂèñÊâÄÊúâÈñãÂïü‰∏îÊúâË≥áÊñôÁöÑÂúñÂ±§
   */
  const visibleLayers = computed(() => {
    const allLayers = dataStore.getAllLayers();
    return allLayers.filter((layer) => layer.visible);
  });

  /**
   * üìë Ë®≠ÂÆö‰ΩúÁî®‰∏≠ÂúñÂ±§ÂàÜÈ†Å (Set Active Layer Tab)
   * @param {string} layerId - ÂúñÂ±§ ID
   */
  const setActiveLayerTab = (layerId) => {
    activeLayerTab.value = layerId;
  };

  /**
   * üìä ÂèñÂæóÂúñÂ±§Ë≥áÊñôÊï∏Èáè (Get Layer Data Count)
   * @param {Object} layer - ÂúñÂ±§Áâ©‰ª∂
   * @returns {number} Ë≥áÊñôÊï∏Èáè
   */
  const getLayerDataCount = (layer) => {
    return layer.tableData?.length || 0;
  };

  /**
   * üìä ÂèñÂæóÊéíÂ∫èÂæåÁöÑË≥áÊñô (Get Sorted Data)
   * @param {Object} layer - ÂúñÂ±§Áâ©‰ª∂
   * @returns {Array} ÊéíÂ∫èÂæåÁöÑË≥áÊñôÈô£Âàó
   */
  const getSortedData = (layer) => {
    if (!layer.tableData) return [];

    const sortState = layerSortStates.value[layer.id];
    if (!sortState || !sortState.key) {
      return layer.tableData;
    }

    return [...layer.tableData].sort((a, b) => {
      const aValue = a[sortState.key];
      const bValue = b[sortState.key];

      // Â≠ó‰∏≤È°ûÂûãÁöÑÊØîËºÉ
      if (typeof aValue === 'string' && typeof bValue === 'string') {
        return sortState.order === 'asc'
          ? aValue.localeCompare(bValue)
          : bValue.localeCompare(aValue);
      }

      // Êï∏ÂÄºÈ°ûÂûãÁöÑÊØîËºÉ
      return sortState.order === 'asc' ? aValue - bValue : bValue - aValue;
    });
  };

  /**
   * üìä ËôïÁêÜÊéíÂ∫èÈªûÊìä (Handle Sort Click)
   * @param {string} layerId - ÂúñÂ±§ ID
   * @param {string} key - ÊéíÂ∫èÊ¨Ñ‰Ωç
   */
  const handleSort = (layerId, key) => {
    if (!layerSortStates.value[layerId]) {
      layerSortStates.value[layerId] = { key: null, order: 'asc' };
    }

    const sortState = layerSortStates.value[layerId];

    if (sortState.key === key) {
      // ÂàáÊèõÊéíÂ∫èÊñπÂêë
      sortState.order = sortState.order === 'asc' ? 'desc' : 'asc';
    } else {
      // Ë®≠ÂÆöÊñ∞ÁöÑÊéíÂ∫èÊ¨Ñ‰Ωç
      sortState.key = key;
      sortState.order = 'asc';
    }
  };

  /**
   * üé® ÂèñÂæóÊéíÂ∫èÂúñÁ§∫ (Get Sort Icon)
   * @param {string} layerId - ÂúñÂ±§ ID
   * @param {string} key - Ê¨Ñ‰ΩçÂêçÁ®±
   * @returns {string} FontAwesome ÂúñÁ§∫È°ûÂà•
   */
  const getSortIcon = (layerId, key) => {
    const sortState = layerSortStates.value[layerId];
    if (!sortState || sortState.key !== key) {
      return 'fas fa-sort';
    }
    return sortState.order === 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down';
  };

  /**
   * üéØ ËôïÁêÜÂú∞ÂúñÈ´ò‰∫ÆÈ°ØÁ§∫ (Handle Map Highlighting)
   * @param {Object} item - Ë¶ÅÈ´ò‰∫ÆÁöÑÈ†ÖÁõÆ
   * @param {Object} layer - ÂúñÂ±§Áâ©‰ª∂
   */
  const handleHighlight = (item, layer) => {
    console.log('Ê∫ñÂÇôÈ´ò‰∫ÆÈ°ØÁ§∫:', { item, layer: layer.name });

    if (!item || !item.name) {
      console.warn('ÁÑ°Ê≥ïÈ´ò‰∫ÆÈ°ØÁ§∫ÔºöË≥áÊñôÁÇ∫Á©∫ÊàñÁº∫Â∞ëÂêçÁ®±');
      return;
    }

    console.log('ÁôºÈÄÅÈ´ò‰∫Æ‰∫ã‰ª∂:', item.name);
    emit('highlight-on-map', item.name);
  };

  /**
   * üé® Ê†ºÂºèÂåñÊï∏ÂÄº (Format Value)
   * @param {any} value - ÂéüÂßãÂÄº
   * @returns {string} Ê†ºÂºèÂåñÂæåÁöÑÂÄº
   */
  const formatValue = (value) => {
    if (typeof value === 'number') {
      return value.toLocaleString();
    }
    return value || '-';
  };

  // Ë®òÈåÑ‰∏ä‰∏ÄÊ¨°ÁöÑÂúñÂ±§ÂàóË°®Áî®ÊñºÊØîËºÉ
  const previousLayers = ref([]);

  /**
   * üëÄ Áõ£ËÅΩÂèØË¶ãÂúñÂ±§ËÆäÂåñÔºåËá™ÂãïÂàáÊèõÂà∞Êñ∞ÈñãÂïüÁöÑÂúñÂ±§ÂàÜÈ†Å
   */
  watch(
    () => visibleLayers.value,
    (newLayers) => {
      // Â¶ÇÊûúÊ≤íÊúâÂèØË¶ãÂúñÂ±§ÔºåÊ∏ÖÈô§ÈÅ∏‰∏≠ÁöÑÂàÜÈ†Å
      if (newLayers.length === 0) {
        activeLayerTab.value = null;
        previousLayers.value = [];
        return;
      }

      // ÊâæÂá∫Êñ∞Â¢ûÁöÑÂúñÂ±§ÔºàÊØîËºÉÊñ∞ËàäÂúñÂ±§ÂàóË°®Ôºâ
      const previousLayerIds = previousLayers.value.map((layer) => layer.id);
      const newLayerIds = newLayers.map((layer) => layer.id);
      const addedLayerIds = newLayerIds.filter((id) => !previousLayerIds.includes(id));

      // Â¶ÇÊûúÊúâÊñ∞Â¢ûÁöÑÂúñÂ±§ÔºåËá™ÂãïÂàáÊèõÂà∞ÊúÄÊñ∞Êñ∞Â¢ûÁöÑÂúñÂ±§
      if (addedLayerIds.length > 0) {
        const newestAddedLayerId = addedLayerIds[addedLayerIds.length - 1];
        activeLayerTab.value = newestAddedLayerId;
        console.log(
          `üîÑ Ëá™ÂãïÂàáÊèõÂà∞Êñ∞ÈñãÂïüÁöÑÂúñÂ±§: ${newLayers.find((layer) => layer.id === newestAddedLayerId)?.name}`
        );
      }
      // Â¶ÇÊûúÁï∂ÂâçÊ≤íÊúâÈÅ∏‰∏≠ÂàÜÈ†ÅÔºåÊàñÈÅ∏‰∏≠ÁöÑÂàÜÈ†Å‰∏çÂú®ÂèØË¶ãÂàóË°®‰∏≠ÔºåÈÅ∏‰∏≠Á¨¨‰∏ÄÂÄã
      else if (
        !activeLayerTab.value ||
        !newLayers.find((layer) => layer.id === activeLayerTab.value)
      ) {
        activeLayerTab.value = newLayers[0].id;
      }

      // Êõ¥Êñ∞Ë®òÈåÑÁöÑÂúñÂ±§ÂàóË°®
      previousLayers.value = [...newLayers];
    },
    { deep: true, immediate: true }
  );

  /**
   * üöÄ ÁµÑ‰ª∂ÊéõËºâ‰∫ã‰ª∂ (Component Mounted Event)
   */
  onMounted(() => {
    console.log('[MultiLayerDataTableTab] Component Mounted');

    // ÂàùÂßãÂåñÁ¨¨‰∏ÄÂÄãÂèØË¶ãÂúñÂ±§ÁÇ∫‰ΩúÁî®‰∏≠ÂàÜÈ†Å
    if (visibleLayers.value.length > 0 && !activeLayerTab.value) {
      activeLayerTab.value = visibleLayers.value[0].id;
    }
  });
</script>

<template>
  <!-- üìä Â§öÂúñÂ±§Ë≥áÊñôË°®Ê†ºÂàÜÈ†ÅÁµÑ‰ª∂ -->
  <div class="h-100 d-flex flex-column">
    <!-- üìë ÂúñÂ±§ÂàÜÈ†ÅÂ∞éËà™ -->
    <div v-if="visibleLayers.length > 0" class="bg-white border-bottom">
      <ul class="nav nav-tabs nav-fill">
        <li v-for="layer in visibleLayers" :key="layer.id" class="nav-item">
          <button
            class="nav-link"
            :class="{
              active: activeLayerTab === layer.id,
            }"
            @click="setActiveLayerTab(layer.id)"
            :title="`È°ØÁ§∫ ${layer.name} ÁöÑË°®Ê†ºË≥áÊñô`"
          >
            {{ layer.name }}
            <span class="badge bg-secondary ms-2" v-if="getLayerDataCount(layer)">
              {{ getLayerDataCount(layer) }}
            </span>
          </button>
        </li>
      </ul>
    </div>

    <!-- üìã ÂúñÂ±§Ë°®Ê†ºÂÖßÂÆπÂçÄÂüü -->
    <div v-if="visibleLayers.length > 0" class="flex-grow-1 overflow-hidden">
      <div
        v-for="layer in visibleLayers"
        :key="layer.id"
        v-show="activeLayerTab === layer.id"
        class="h-100"
      >
        <!-- üîÑ ËºâÂÖ•‰∏≠ÁãÄÊÖã -->
        <div v-if="layer.isLoading" class="h-100 d-flex align-items-center justify-content-center">
          <div class="text-center">
            <div class="spinner-border text-primary mb-3" role="status">
              <span class="visually-hidden">ËºâÂÖ•‰∏≠...</span>
            </div>
            <p class="text-muted">Ê≠£Âú®ËºâÂÖ• {{ layer.name }} ÁöÑË≥áÊñô...</p>
          </div>
        </div>

        <!-- üìã Ë°®Ê†ºÂÖßÂÆπ -->
        <div
          v-else-if="layer.isLoaded && getSortedData(layer).length > 0"
          class="h-100 d-flex flex-column"
        >
          <!-- üìä ÂúñÂ±§Áµ±Ë®àË≥áË®ä -->
          <div class="bg-light px-3 py-2 border-bottom">
            <div class="d-flex align-items-center justify-content-between">
              <div>
                <strong>{{ layer.name }}</strong>
                <span class="text-muted ms-2">Á∏ΩË®à: {{ getLayerDataCount(layer) }} Á≠Ü</span>
              </div>
            </div>
          </div>

          <!-- üìã Bootstrap Ë°®Ê†º -->
          <div class="flex-grow-1 overflow-auto">
            <table class="table table-sm table-hover table-striped mb-0">
              <thead class="table-light sticky-top">
                <tr class="text-center">
                  <th
                    @click="handleSort(layer.id, 'id')"
                    class="user-select-none"
                    style="cursor: pointer"
                  >
                    ID
                    <i :class="getSortIcon(layer.id, 'id')" class="ms-1"></i>
                  </th>
                  <th
                    @click="handleSort(layer.id, 'name')"
                    class="user-select-none"
                    style="cursor: pointer"
                  >
                    ÂêçÁ®±
                    <i :class="getSortIcon(layer.id, 'name')" class="ms-1"></i>
                  </th>
                  <th
                    @click="handleSort(layer.id, 'count')"
                    class="user-select-none"
                    style="cursor: pointer"
                  >
                    Êï∏Èáè
                    <i :class="getSortIcon(layer.id, 'count')" class="ms-1"></i>
                  </th>
                  <th>Êìç‰Ωú</th>
                </tr>
              </thead>
              <tbody>
                <tr
                  v-for="(item, index) in getSortedData(layer)"
                  :key="item.id || item.name || index"
                  class="text-center align-middle"
                >
                  <td>{{ item.id }}</td>
                  <td>{{ item.name }}</td>
                  <td>{{ formatValue(item.count) }}</td>
                  <td>
                    <button
                      class="btn btn-primary btn-sm"
                      @click="handleHighlight(item, layer)"
                      title="Âú®Âú∞Âúñ‰∏äÈ´ò‰∫ÆÈ°ØÁ§∫"
                    >
                      È°ØÁ§∫‰ΩçÁΩÆ
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- üì≠ Á©∫ÁãÄÊÖãÈ°ØÁ§∫ -->
        <div v-else class="h-100 d-flex align-items-center justify-content-center bg-light">
          <div class="text-center text-muted">
            <i class="fas fa-table fa-3x mb-3"></i>
            <h5>{{ layer.name }}</h5>
            <p v-if="!layer.isLoaded">Ê≠§ÂúñÂ±§Â∞öÊú™ËºâÂÖ•Ë≥áÊñô„ÄÇ</p>
            <p v-else>Ê≠§ÂúñÂ±§Ê≤íÊúâÂèØÈ°ØÁ§∫ÁöÑË≥áÊñô„ÄÇ</p>
          </div>
        </div>
      </div>
    </div>

    <!-- üì≠ ÁÑ°ÈñãÂïüÂúñÂ±§ÁöÑÁ©∫ÁãÄÊÖã -->
    <div v-else class="flex-grow-1 d-flex align-items-center justify-content-center bg-light">
      <div class="text-center text-muted">
        <i class="fas fa-layer-group fa-3x mb-3"></i>
        <h5>Ê≤íÊúâÈñãÂïüÁöÑÂúñÂ±§</h5>
        <p>Ë´ãÂú®Â∑¶ÂÅ¥Èù¢ÊùøÈñãÂïüÂúñÂ±§‰ª•Êü•ÁúãË≥áÊñôË°®Ê†º„ÄÇ</p>
      </div>
    </div>
  </div>
</template>

<style scoped>
  /* ÊúÄÂ∞èÂåñËá™ÂÆöÁæ©Ê®£ÂºèÔºå‰∏ªË¶Å‰ΩøÁî® Bootstrap */
</style>
