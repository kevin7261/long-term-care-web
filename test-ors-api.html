<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>測試 ORS Directions API</title>
    <style>
      body {
        font-family: sans-serif;
        padding: 20px;
        max-width: 800px;
        margin: 0 auto;
      }
      button {
        font-size: 16px;
        padding: 10px 20px;
        cursor: pointer;
        margin: 10px 5px;
        border: none;
        border-radius: 5px;
        background-color: #007bff;
        color: white;
      }
      button:hover {
        background-color: #0056b3;
      }
      #results {
        margin-top: 20px;
        padding: 15px;
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        white-space: pre-wrap;
        font-family: monospace;
      }
      .success {
        background-color: #d4edda;
        border-color: #c3e6cb;
      }
      .error {
        background-color: #f8d7da;
        border-color: #f5c6cb;
      }
      .info {
        background-color: #d1ecf1;
        border-color: #bee5eb;
      }
    </style>
  </head>
  <body>
    <h1>測試 ORS Directions API</h1>
    <p>測試不同的路徑規劃場景，驗證 API 修正是否有效。</p>

    <button id="testTaipei">測試台北市區路線</button>
    <button id="testShort">測試短距離路線</button>
    <button id="testLong">測試長距離路線</button>
    <button id="testError">測試錯誤處理</button>

    <div id="results" class="info">點擊按鈕開始測試...</div>

    <script>
      // API 配置
      const apiKey = '5b3ce3597851110001cf6248cd3e1a052bec45bc8410b037091bb766';

      // 取得頁面元素
      const resultsDiv = document.getElementById('results');
      const testTaipeiBtn = document.getElementById('testTaipei');
      const testShortBtn = document.getElementById('testShort');
      const testLongBtn = document.getElementById('testLong');
      const testErrorBtn = document.getElementById('testError');

      // 通用的路線規劃函數
      async function testRoute(coordinates, testName, profile = 'driving-car') {
        resultsDiv.className = 'info';
        resultsDiv.textContent = `正在測試: ${testName}...`;

        try {
          console.log(`🛣️ 開始測試: ${testName}`);
          console.log('路徑點坐標:', coordinates);

          // 使用修正後的 API URL 格式
          const apiUrl = `https://api.openrouteservice.org/v2/directions/${profile}/geojson`;

          const response = await fetch(apiUrl, {
            method: 'POST',
            headers: {
              Accept:
                'application/json, application/geo+json, application/gpx+xml, img/png; charset=utf-8',
              'Content-Type': 'application/json',
              Authorization: apiKey,
            },
            body: JSON.stringify({
              coordinates: coordinates,
            }),
          });

          if (!response.ok) {
            let errorMessage = `HTTP ${response.status}`;
            try {
              const errorData = await response.json();
              if (errorData.error && errorData.error.message) {
                errorMessage = errorData.error.message;
              }
            } catch (parseError) {
              errorMessage = `HTTP ${response.status} - ${response.statusText}`;
            }
            throw new Error(`ORS API 錯誤: ${errorMessage}`);
          }

          const data = await response.json();

          if (!data.features || data.features.length === 0) {
            throw new Error('API 返回的路徑數據為空');
          }

          // 解析結果
          const summary = data.features[0].properties.summary;
          const distanceKm = (summary.distance / 1000).toFixed(2);
          const durationMin = Math.round(summary.duration / 60);

          // 顯示成功結果
          resultsDiv.className = 'success';
          resultsDiv.textContent = `✅ ${testName} - 測試成功！

路徑點數量: ${coordinates.length} 個
總距離: ${distanceKm} 公里
預估時間: ${durationMin} 分鐘
交通方式: ${profile}

路徑點坐標:
${coordinates.map((coord, index) => `  ${index + 1}. [${coord[0]}, ${coord[1]}]`).join('\n')}

API 響應狀態: ${response.status} ${response.statusText}
返回的 GeoJSON features: ${data.features.length} 個
幾何類型: ${data.features[0].geometry.type}`;

          console.log(`✅ ${testName} 測試成功`);
          console.log(`📏 距離: ${distanceKm} 公里`);
          console.log(`⏱️ 時間: ${durationMin} 分鐘`);
        } catch (error) {
          console.error(`❌ ${testName} 測試失敗:`, error);

          resultsDiv.className = 'error';
          resultsDiv.textContent = `❌ ${testName} - 測試失敗！

錯誤訊息: ${error.message}

路徑點坐標:
${coordinates.map((coord, index) => `  ${index + 1}. [${coord[0]}, ${coord[1]}]`).join('\n')}

請檢查:
1. 網路連線是否正常
2. API 金鑰是否有效
3. 路徑點坐標是否正確
4. 是否超過 API 使用限制`;
        }
      }

      // 測試案例 1: 台北市區路線 (龍山寺 -> 西門紅樓 -> 台北車站)
      testTaipeiBtn.addEventListener('click', () => {
        const coordinates = [
          [121.5, 25.0372], // 龍山寺
          [121.5073, 25.0428], // 西門紅樓
          [121.5175, 25.0479], // 台北車站
        ];
        testRoute(coordinates, '台北市區路線測試');
      });

      // 測試案例 2: 短距離路線 (2個點)
      testShortBtn.addEventListener('click', () => {
        const coordinates = [
          [121.5654, 25.033], // 台北101附近
          [121.57, 25.035], // 附近另一點
        ];
        testRoute(coordinates, '短距離路線測試');
      });

      // 測試案例 3: 長距離路線 (台北到桃園)
      testLongBtn.addEventListener('click', () => {
        const coordinates = [
          [121.5175, 25.0479], // 台北車站
          [121.2168, 24.9539], // 桃園車站
        ];
        testRoute(coordinates, '長距離路線測試');
      });

      // 測試案例 4: 錯誤處理 (無效坐標)
      testErrorBtn.addEventListener('click', () => {
        const coordinates = [
          [999, 999], // 無效坐標
          [888, 888], // 無效坐標
        ];
        testRoute(coordinates, '錯誤處理測試');
      });
    </script>
  </body>
</html>
