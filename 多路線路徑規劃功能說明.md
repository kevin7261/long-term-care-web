# 多路線路徑規劃功能說明

## 🎯 功能需求

用戶要求每次按下「路徑規劃點選完成」後，將這次規劃的路線保存為一筆獨立的資料記錄，然後清空當前的路徑點，準備開始下一條路線的規劃。

## 🔄 工作流程

### 完整的多路線規劃流程

```
第一條路線：
1. 點擊「點選路徑規劃點」
2. 在地圖上選擇多個路徑點 (顯示橘色數字 1, 2, 3...)
3. 點擊「路徑規劃點選完成」
4. ✅ 路線 1 計算完成並保存
5. 🔄 自動清空當前路徑點，準備下一條路線

第二條路線：
6. 再次點擊「點選路徑規劃點」
7. 在地圖上選擇新的路徑點 (重新從 1 開始編號)
8. 點擊「路徑規劃點選完成」
9. ✅ 路線 2 計算完成並保存
10. 🔄 再次清空當前路徑點

...依此類推，可以無限添加路線
```

## 🗂️ 數據結構設計

### 路線記錄結構

每條完成的路線都會保存為一個獨立的 GeoJSON 要素：

```javascript
{
  type: 'Feature',
  geometry: {
    type: 'LineString',
    coordinates: [[lng1, lat1], [lng2, lat2], ...] // ORS 返回的路線幾何
  },
  properties: {
    id: 'route_1640995200000_abc123',
    layerId: 'route-planning-layer',
    type: 'route-line',
    name: '路線 1',
    routeNumber: 1,                    // 路線編號
    distance: 5.23,                    // 距離（公里）
    duration: 18,                      // 時間（分鐘）
    profile: 'driving-car',            // 交通方式
    waypoints: 4,                      // 路徑點數量
    startPointName: '路徑點 1',        // 起點名稱
    endPointName: '路徑點 4',          // 終點名稱
    createdAt: '2024-01-15T10:30:00.000Z'
  }
}
```

### 表格數據結構

表格會顯示所有已完成的路線 + 當前正在規劃的路線：

```javascript
[
  // 已完成的路線
  {
    '#': 1,
    名稱: '路線 1',
    類型: '已完成路線',
    起點: '路徑點 1',
    終點: '路徑點 4',
    路徑點數: 4,
    總距離: '5.23 公里',
    預估時間: '18 分鐘',
    建立時間: '2024/1/15 上午10:30:00',
    狀態: '已完成',
  },
  {
    '#': 2,
    名稱: '路線 2',
    類型: '已完成路線',
    起點: '路徑點 1',
    終點: '路徑點 3',
    路徑點數: 3,
    總距離: '3.45 公里',
    預估時間: '12 分鐘',
    建立時間: '2024/1/15 上午10:35:00',
    狀態: '已完成',
  },
  // 當前正在規劃的路線（如果有的話）
  {
    '#': 3,
    名稱: '路線 3',
    類型: '規劃中',
    起點: '路徑點 1',
    終點: '路徑點 2',
    路徑點數: 2,
    總距離: '-',
    預估時間: '-',
    建立時間: '2024/1/15 上午10:40:00',
    狀態: '規劃中',
  },
];
```

## 🔧 技術實現

### 1. 修改 `calculateAndDrawRoute` 函數

#### 核心變更：路線完成後清空當前路徑點

```javascript
// 🔥 關鍵修改：清除當前的路徑規劃點，準備下一次規劃
routePlanningLayer.geoJsonData.features =
  routePlanningLayer.geoJsonData.features.filter(
    (f) => f.properties.type !== 'route-planning-point'
  );
```

#### 路線編號自動生成

```javascript
// 獲取已完成的路線數量，用於生成路線編號
const existingRoutes = routePlanningLayer.geoJsonData.features.filter(
  (f) => f.properties.type === 'route-line'
);
const routeNumber = existingRoutes.length + 1;
```

#### 保存起點終點名稱

```javascript
// 獲取當前路徑點（在清除前保存信息）
const currentRoutePoints = routePlanningLayer.geoJsonData.features.filter(
  (f) => f.properties.type === 'route-planning-point'
);

const firstPoint = currentRoutePoints[0];
const lastPoint = currentRoutePoints[currentRoutePoints.length - 1];

// 保存到路線屬性中
startPointName: firstPoint.properties.name,
endPointName: lastPoint.properties.name,
```

### 2. 重寫 `updateRoutePlanningLayerData` 函數

#### 分別處理已完成路線和當前路徑點

```javascript
// 獲取已完成的路線
const completedRoutes = routePlanningLayer.geoJsonData.features.filter(
  (f) => f.properties.type === 'route-line'
);

// 獲取當前正在規劃的路徑點
const currentRoutePoints = routePlanningLayer.geoJsonData.features.filter(
  (f) => f.properties.type === 'route-planning-point'
);
```

#### 動態摘要描述

```javascript
let description = '';
if (completedRoutes.length > 0 && currentRoutePoints.length > 0) {
  description = `已完成 ${completedRoutes.length} 條路線，正在規劃第 ${completedRoutes.length + 1} 條路線（已選擇 ${currentRoutePoints.length} 個路徑點）`;
} else if (completedRoutes.length > 0) {
  description = `已完成 ${completedRoutes.length} 條路線，總距離 ${totalDistance.toFixed(2)} 公里，總時間 ${totalDuration} 分鐘`;
} else {
  description = `正在規劃第 1 條路線，已選擇 ${currentRoutePoints.length} 個路徑點`;
}
```

#### 統計總距離和時間

```javascript
const totalDistance = completedRoutes.reduce(
  (sum, route) => sum + (route.properties.distance || 0),
  0
);
const totalDuration = completedRoutes.reduce(
  (sum, route) => sum + (route.properties.duration || 0),
  0
);
```

### 3. 用戶體驗改進

#### 成功提示更新

```javascript
alert(
  `路徑規劃完成！\n\n路線 ${routeResult.routeNumber} 已保存\n總距離: ${routeResult.distance} 公里\n預估時間: ${routeResult.duration} 分鐘\n\n可以繼續添加下一條路線`
);
```

#### 控制台日誌增強

```javascript
console.log(`✅ 路徑規劃完成！路線 ${routeNumber} 已保存`);
console.log(`📏 總距離: ${distanceKm} 公里`);
console.log(`⏱️ 預估時間: ${durationMin} 分鐘`);
console.log(`🔄 已清空當前路徑點，可以開始規劃下一條路線`);
```

## 📊 數據顯示邏輯

### 摘要數據邏輯

```javascript
// 計算總數量：已完成路線數 + (如果有正在規劃的點則+1)
const totalCount =
  completedRoutes.length + (currentRoutePoints.length > 0 ? 1 : 0);

// 顯示範圍
coverage: completedRoutes.length > 0
  ? `${totalDistance.toFixed(2)} 公里` // 有完成路線時顯示總距離
  : `${currentRoutePoints.length} 個路徑點`; // 只有規劃中路徑點時顯示點數
```

### 表格數據邏輯

```javascript
// 1. 先添加所有已完成的路線
completedRoutes.forEach((route, index) => {
  tableData.push({
    '#': index + 1,
    名稱: route.properties.name,
    類型: '已完成路線',
    // ... 其他屬性
    狀態: '已完成',
  });
});

// 2. 如果有正在規劃的路徑點，添加到表格末尾
if (currentRoutePoints.length > 0) {
  tableData.push({
    '#': completedRoutes.length + 1,
    名稱: `路線 ${completedRoutes.length + 1}`,
    類型: '規劃中',
    // ... 其他屬性
    狀態: '規劃中',
  });
}
```

## 🎨 視覺化效果

### 地圖顯示

- **已完成路線**: 橘色實線，持續顯示在地圖上
- **當前路徑點**: 橘色數字圓圈，完成後會被清除
- **多條路線**: 同時顯示，可以透過懸停查看個別路線資訊

### 彈出視窗

#### 已完成路線的彈出視窗

```html
路徑規劃圖層 路線 1 總距離: 5.23 公里 預估時間: 18 分鐘 路徑點數: 4 個
```

#### 正在規劃路徑點的彈出視窗

```html
路徑規劃圖層 路徑點 1 順序: 1
```

## 🔄 狀態轉換

### 路線生命週期

```
1. 空白狀態
   ↓ (點擊開始規劃)
2. 規劃中狀態 (有路徑點，無路線)
   ↓ (點擊完成規劃)
3. 已完成狀態 (有路線，無當前路徑點)
   ↓ (點擊開始下一條)
4. 混合狀態 (有已完成路線 + 新的路徑點)
   ↓ (點擊完成規劃)
5. 多路線完成狀態 (多條已完成路線)
```

### 狀態描述範例

```javascript
// 空白狀態
'尚未開始路徑規劃，點選地圖開始規劃路徑';

// 規劃中狀態
'正在規劃第 1 條路線，已選擇 3 個路徑點';

// 單路線完成
'已完成 1 條路線，總距離 5.23 公里，總時間 18 分鐘';

// 混合狀態
'已完成 1 條路線，正在規劃第 2 條路線（已選擇 2 個路徑點）';

// 多路線完成
'已完成 3 條路線，總距離 15.67 公里，總時間 45 分鐘';
```

## ✅ 功能特點

### ✅ 已實現功能

- ✅ **多路線管理**: 支援無限數量的路線規劃
- ✅ **自動編號**: 路線自動按順序編號（路線 1, 路線 2, ...）
- ✅ **獨立保存**: 每條路線都是獨立的資料記錄
- ✅ **自動清空**: 完成規劃後自動清空當前路徑點
- ✅ **統計匯總**: 顯示總距離、總時間統計
- ✅ **狀態追蹤**: 區分「已完成」和「規劃中」狀態
- ✅ **視覺區分**: 不同狀態有不同的表格顯示
- ✅ **持續顯示**: 所有已完成路線持續在地圖上顯示
- ✅ **詳細資訊**: 保存起點終點名稱、路徑點數等詳細資訊

### 🔄 工作流程優化

- **直觀操作**: 每次「完成」就是一筆新記錄
- **連續規劃**: 可以連續規劃多條路線而不需要手動清空
- **狀態清晰**: 表格清楚顯示哪些是已完成、哪些在規劃中
- **統計完整**: 提供個別路線和總體統計

## 🚀 使用範例

### 規劃多條路線

```javascript
// 第一條路線
dataStore.addRoutePlanningPoint(25.033, 121.5654); // 路徑點 1
dataStore.addRoutePlanningPoint(25.035, 121.57); // 路徑點 2
await dataStore.calculateAndDrawRoute(); // 完成路線 1，自動清空路徑點

// 第二條路線 (路徑點編號重新從 1 開始)
dataStore.addRoutePlanningPoint(25.04, 121.58); // 路徑點 1
dataStore.addRoutePlanningPoint(25.045, 121.585); // 路徑點 2
dataStore.addRoutePlanningPoint(25.05, 121.59); // 路徑點 3
await dataStore.calculateAndDrawRoute(); // 完成路線 2，自動清空路徑點

// 結果：地圖上顯示兩條橘色路線，表格顯示兩筆已完成記錄
```

### 查看統計資訊

```javascript
const routePlanningLayer = dataStore.findLayerById('route-planning-layer');

// 查看摘要
console.log(routePlanningLayer.summaryData.description);
// 輸出: "已完成 2 條路線，總距離 8.45 公里，總時間 25 分鐘"

// 查看表格數據
console.log(routePlanningLayer.tableData);
// 輸出: 包含兩筆已完成路線記錄的陣列
```

---

_此功能實現了完整的多路線路徑規劃管理系統，每次規劃都會產生一筆獨立的記錄，支援連續規劃多條路線，並提供完整的統計和視覺化功能。_
