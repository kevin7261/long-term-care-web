# 等時圈分析右側面板功能實現說明

## 🎯 功能需求

用戶要求等時圈分析圖層與數據分析圖層一樣，在右側面板（RightPanel）顯示「範圍內點物件」的清單。

## 🔍 原有功能分析

### 數據分析圖層的右側面板顯示

數據分析圖層已經在 `PropertiesTab.vue` 中實現了以下功能：

- 當選中分析圖層物件時，顯示範圍內點物件清單
- 顯示範圍內多邊形物件清單
- 顯示各圖層的統計資訊

### 實現邏輯

```javascript
// 檢查是否為分析圖層物件
const isAnalysisObject = computed(() => {
  return selectedFeature.value?.properties?.layerId === 'analysis-layer';
});

// 獲取範圍內點位清單
const pointsInRange = computed(() => {
  if (!isAnalysisObject.value) return [];
  return selectedFeature.value?.properties?.pointsInRange || [];
});
```

## 🛠️ 實現方案

### 1. 新增等時圈分析圖層檢測

在 `PropertiesTab.vue` 中新增：

```javascript
/**
 * 🚗 是否為等時圈分析圖層物件 (Is Isochrone Analysis Layer Object)
 * 檢查選中物件是否為等時圈分析圖層的物件
 */
const isIsochroneAnalysisObject = computed(() => {
  return (
    selectedFeature.value?.properties?.layerId === 'isochrone-analysis-layer'
  );
});
```

### 2. 修改範圍內物件清單邏輯

將原有的邏輯擴展為同時支援兩種分析圖層：

```javascript
/**
 * 📍 範圍內點位清單 (Points In Range List)
 * 獲取分析圖層物件範圍內的點清單（支援數據分析和等時圈分析）
 */
const pointsInRange = computed(() => {
  if (!isAnalysisObject.value && !isIsochroneAnalysisObject.value) return [];
  return selectedFeature.value?.properties?.pointsInRange || [];
});

/**
 * 🏢 範圍內多邊形清單 (Polygon In Range List)
 * 獲取分析圖層物件範圍內的多邊形清單（支援數據分析和等時圈分析）
 */
const polygonInRange = computed(() => {
  if (!isAnalysisObject.value && !isIsochroneAnalysisObject.value) return [];
  return selectedFeature.value?.properties?.polygonInRange || [];
});
```

### 3. 修改統計資訊邏輯

同樣擴展統計功能：

```javascript
/**
 * 📊 圖層統計 (Layer Statistics)
 * 獲取範圍內各圖層的統計信息（點物件）（支援數據分析和等時圈分析）
 */
const layerStats = computed(() => {
  if (!isAnalysisObject.value && !isIsochroneAnalysisObject.value) return {};
  return selectedFeature.value?.properties?.layerStats || {};
});

/**
 * 🏢 多邊形圖層統計 (Polygon Layer Statistics)
 * 獲取範圍內各圖層的統計信息（多邊形物件）（支援數據分析和等時圈分析）
 */
const polygonStats = computed(() => {
  if (!isAnalysisObject.value && !isIsochroneAnalysisObject.value) return {};
  return selectedFeature.value?.properties?.polygonStats || {};
});
```

### 4. 修改模板條件判斷

在模板中更新條件判斷：

```html
<!-- 🎯 分析圖層專用：範圍內物件清單（支援數據分析和等時圈分析） -->
<template
  v-if="(isAnalysisObject || isIsochroneAnalysisObject) && (pointsInRange.length > 0 || polygonInRange.length > 0)"
>
  <!-- 📍 點物件清單 -->
  <template v-if="pointsInRange.length > 0">
    <hr class="my-3" />
    <div class="my-title-xs-gray mb-3">
      範圍內點物件 {{ pointsInRange.length }}
    </div>
    <DetailItem
      v-for="(point, index) in pointsInRange"
      :key="index"
      :label="point.properties.layerName"
      :value="`${point.properties.name} (${point.distance}m)`"
    />
  </template>

  <!-- 🏢 多邊形物件清單 -->
  <template v-if="polygonInRange.length > 0">
    <hr class="my-3" />
    <div class="my-title-xs-gray mb-3">
      範圍內面域物件 {{ polygonInRange.length }}
    </div>
    <DetailItem
      v-for="(polygon, index) in polygonInRange"
      :key="index"
      :label="polygon.properties.layerName"
      :value="polygon.properties.name"
    />
  </template>
</template>
```

### 5. 更新 return 語句

將新的計算屬性暴露給模板：

```javascript
return {
  selectedFeature, // 選中物件
  selectedLayer, // 選中圖層
  layerName, // 圖層名稱
  hasProperties, // 是否有屬性
  isAnalysisObject, // 是否為分析圖層物件
  isIsochroneAnalysisObject, // 是否為等時圈分析圖層物件
  pointsInRange, // 範圍內點位清單
  polygonInRange, // 範圍內多邊形清單
  allObjectsInRange, // 範圍內所有物件清單
  layerStats, // 點圖層統計
  polygonStats, // 多邊形圖層統計
  combinedStats, // 整合統計
};
```

## 🎯 實現效果

### 修改前

- ❌ 等時圈分析圖層選中時，右側面板不顯示範圍內點物件清單
- ❌ 只有數據分析圖層有此功能

### 修改後

- ✅ 等時圈分析圖層選中時，右側面板顯示範圍內點物件清單
- ✅ 數據分析圖層和等時圈分析圖層功能完全一致
- ✅ 顯示內容包括：
  - 範圍內點物件數量
  - 每個點物件的圖層名稱
  - 每個點物件的名稱和距離
  - 範圍內多邊形物件（如有）

## 📊 顯示內容說明

### 點物件清單顯示格式

```
範圍內點物件 15

醫院: 台大醫院 (850m)
診所: 仁愛診所 (1200m)
藥局: 康是美藥局 (300m)
社區照顧關懷據點: 松山據點 (650m)
...
```

### 多邊形物件清單顯示格式

```
範圍內面域物件 3

行政區界: 信義區
人口統計-65歲以上: 信義區永吉里
綜稅綜合所得總額-中位數: 信義區永吉里
```

## 🔄 數據流程

1. **用戶點擊等時圈分析結果**

   - 地圖上的等時圈多邊形或分析點

2. **系統設置選中物件**

   - `dataStore.setSelectedFeature(feature)`

3. **PropertiesTab 檢測圖層類型**

   - `isIsochroneAnalysisObject.value` 返回 `true`

4. **獲取範圍內物件數據**

   - 從 `feature.properties.pointsInRange` 獲取點物件清單
   - 從 `feature.properties.polygonInRange` 獲取多邊形物件清單

5. **右側面板顯示清單**
   - 渲染點物件清單和多邊形物件清單

## 🎨 UI 一致性

等時圈分析圖層的右側面板顯示與數據分析圖層完全一致：

- 相同的標題格式
- 相同的物件顯示格式
- 相同的分隔線樣式
- 相同的距離顯示（對點物件）

## 🧪 測試建議

### 測試步驟

1. 開啟重要的長照設施圖層（醫院、診所等）
2. 點擊地圖進行等時圈分析
3. 點擊生成的等時圈多邊形或分析點
4. 檢查右側面板是否顯示範圍內點物件清單
5. 驗證顯示的設施數量和距離是否正確

### 預期結果

- 右側面板顯示「範圍內點物件 X」標題
- 列出所有在等時圈範圍內的設施
- 每個設施顯示圖層名稱、設施名稱和距離
- 功能與數據分析圖層完全一致

---

_此實現確保等時圈分析圖層與數據分析圖層在右側面板顯示功能上完全一致，提供統一的用戶體驗。_
