# 路徑規劃圖層功能實現說明

## 🎯 功能需求

用戶要求新增一個「路徑規劃圖層」，位於「等時圈分析圖層」下方，包含以下功能：

- 地圖上添加「點選路徑規劃點」按鈕
- 按下後可以在地圖上任意點擊點位，不限數量
- 直到點擊「路徑規劃點選完成」按鈕後結束功能

## 🛠️ 實現方案

### 1. 數據存儲層 (dataStore.js)

#### 新增路徑規劃圖層定義

```javascript
{
  layerId: 'route-planning-layer',
  layerName: '路徑規劃圖層',
  visible: true, // 預設開啟
  isLoading: false,
  isLoaded: true,
  type: 'route-planning',
  shape: 'point',
  colorName: 'green', // 綠色主題
  geoJsonData: {
    type: 'FeatureCollection',
    features: [],
  },
  summaryData: {
    totalCount: 0,
    type: '路徑規劃點',
    description: '共 0 個路徑規劃點，點選完成後可進行路徑規劃',
    lastUpdated: new Date().toISOString(),
    coverage: '0 個路徑點',
  },
  tableData: [],
  legendData: null,
  loader: null,
  fileName: null,
  fieldName: null,
  isRoutePlanningLayer: true, // 特殊標記
}
```

#### 新增路徑規劃相關函數

**`addRoutePlanningPoint(lat, lng)`**

- 在指定位置添加路徑規劃點
- 自動按順序編號（路徑點 1、路徑點 2...）
- 支援無限數量的路徑點添加

**`clearRoutePlanningLayer()`**

- 清空所有路徑規劃點
- 重置圖層狀態

**`deleteRoutePlanningPoint(pointId)`**

- 刪除指定的路徑規劃點
- 重新整理剩餘路徑點的順序編號

**`getRoutePlanningCoordinates()`**

- 返回所有路徑規劃點的坐標陣列
- 按順序排列，可用於後續路徑規劃API調用

**`updateRoutePlanningLayerData(routePlanningLayer)`**

- 更新圖層統計數據和表格數據
- 在添加、刪除路徑點後自動調用

### 2. 用戶界面層 (MapTab.vue)

#### 新增按鈕組件

```html
<!-- 點選路徑規劃點 -->
<button
  v-if="!isRoutePlanningClickMode"
  class="btn rounded-pill border-0 my-btn-purple my-font-size-xs text-nowrap my-cursor-pointer"
  @click="startRoutePlanningClickMode"
  title="在地圖上點選多個位置進行路徑規劃"
>
  點選路徑規劃點
</button>
<button
  v-else
  class="btn rounded-pill border-0 my-btn-red my-font-size-xs text-nowrap my-cursor-pointer"
  @click="finishRoutePlanningClickMode"
  title="完成路徑規劃點選"
>
  路徑規劃點選完成
</button>
```

#### 新增點擊模式狀態

```javascript
let isRoutePlanningClickMode = ref(false); // 路徑規劃點擊模式狀態
```

#### 新增模式控制函數

**`startRoutePlanningClickMode()`**

- 開始路徑規劃點擊模式
- 自動關閉其他分析模式（互斥邏輯）
- 設置地圖游標為十字型

**`finishRoutePlanningClickMode()`**

- 完成路徑規劃點選
- 恢復正常地圖游標
- 輸出路徑點統計信息

**`addRoutePlanningPoint(lat, lng)`**

- 調用 dataStore 的添加路徑點方法
- 錯誤處理和日誌記錄

### 3. 地圖事件處理

#### 地圖點擊事件

```javascript
} else if (isRoutePlanningClickMode.value) {
  // 如果處於路徑規劃點擊模式，添加路徑規劃點並阻止其他事件
  e.originalEvent.stopPropagation();
  addRoutePlanningPoint(e.latlng.lat, e.latlng.lng);
  return false; // 阻止事件繼續傳播
}
```

#### 圖層點擊事件

```javascript
// 如果處於路徑規劃點擊模式，阻止圖層選擇並添加路徑規劃點
if (isRoutePlanningClickMode.value) {
  e.originalEvent.stopPropagation();
  addRoutePlanningPoint(e.latlng.lat, e.latlng.lng);
  return false;
}
```

#### 滑鼠懸停事件

```javascript
// 如果處於點擊模式，禁用 hover 效果
if (
  isClickMode.value ||
  isIsochroneClickMode.value ||
  isRoutePlanningClickMode.value
) {
  return;
}
```

### 4. 視覺化渲染

#### 路徑規劃點圖標

```javascript
if (feature.properties.type === 'route-planning-point') {
  // 路徑規劃點：綠色數字標記
  const order = feature.properties.order || 1;
  const icon = L.divIcon({
    html: `
    <div class="d-flex align-items-center justify-content-center my-color-white my-font-size-xs fw-bold"
         style="background: var(--my-color-green); border-radius: 50%; width: 20px; height: 20px; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);">
      ${order}
    </div>
    `,
    className: 'route-planning-point-icon',
    iconSize: [24, 24],
    iconAnchor: [12, 12],
    popupAnchor: [0, -12],
  });
  const marker = L.marker(latlng, { icon });
  return marker;
}
```

#### 彈出視窗配置

```javascript
layer.bindPopup(
  `
  <div class="">
    <div class="my-title-xs-gray pb-2">${layerName}</div>
    <div class="my-content-sm-black">${feature.properties.name}</div>
    <div class="my-content-xs-gray pt-1">順序: ${feature.properties.order}</div>
  </div>
  `,
  {
    className: 'route-planning-popup',
    offset: [0, -5],
    closeButton: true,
    autoClose: false,
    closeOnClick: false,
  }
);
```

### 5. 互斥邏輯實現

#### 三種點擊模式互斥

- **數據分析模式** (綠色按鈕)
- **等時圈分析模式** (藍色按鈕)
- **路徑規劃模式** (橘色按鈕)

```javascript
// 開始路徑規劃點擊模式
const startRoutePlanningClickMode = () => {
  // 🔄 互斥邏輯：關閉其他點擊模式
  if (isClickMode.value) {
    stopClickMode();
  }
  if (isIsochroneClickMode.value) {
    stopIsochroneClickMode();
  }

  isRoutePlanningClickMode.value = true;
  // ... 設置UI狀態
};
```

#### 其他模式也會關閉路徑規劃模式

```javascript
// 開始數據分析模式時
if (isRoutePlanningClickMode.value) {
  finishRoutePlanningClickMode();
}

// 開始等時圈分析模式時
if (isRoutePlanningClickMode.value) {
  finishRoutePlanningClickMode();
}
```

### 6. CSS 樣式

#### 路徑規劃點圖標樣式

```css
/* 🗺️ 路徑規劃點圖標樣式 (Route Planning Point Icon Styles) */
:deep(.route-planning-point-icon) {
  background: transparent !important;
  border: none !important;
}
```

#### 路徑規劃點擊模式游標樣式

```css
/* 🗺️ 路徑規劃點擊模式樣式 (Route Planning Click Mode Styles) */
.route-planning-click-mode-active,
.route-planning-click-mode-active * {
  cursor: crosshair !important;
}
```

## 🎨 用戶體驗設計

### 視覺區分

- **數據分析圖層**: 綠色主題，加號圖標
- **等時圈分析圖層**: 藍色主題，加號圖標
- **路徑規劃圖層**: 橘色主題，數字圖標

### 按鈕狀態

- **未啟用**: 顯示「點選路徑規劃點」（橘色按鈕）
- **已啟用**: 顯示「路徑規劃點選完成」（紅色按鈕）

### 路徑點特色

- 橘色圓形背景
- 白色數字顯示順序
- 白色邊框和陰影效果
- 24x24 像素大小

### 交互反饋

- 點擊模式時地圖游標變為十字型
- 控制台輸出詳細的操作日誌
- 完成時顯示路徑點統計信息

## 🔄 操作流程

### 基本使用流程

1. **點擊「點選路徑規劃點」按鈕**

   - 按鈕變為紅色「路徑規劃點選完成」
   - 地圖游標變為十字型
   - 其他分析模式自動關閉

2. **在地圖上點選路徑點**

   - 每次點擊添加一個編號的路徑點
   - 路徑點 1、路徑點 2、路徑點 3...
   - 無數量限制，可以添加任意多個點

3. **點擊「路徑規劃點選完成」按鈕**
   - 結束路徑規劃點選模式
   - 恢復正常地圖游標
   - 控制台顯示路徑點統計

### 高級功能

- **右鍵刪除**: 可以右鍵點擊路徑點進行刪除
- **順序重排**: 刪除路徑點後自動重新編號
- **坐標獲取**: 可以獲取所有路徑點的坐標用於API調用
- **清空圖層**: 可以一次清空所有路徑規劃點

## 🧪 測試場景

### 功能測試

1. **基本添加測試**

   - 點擊按鈕啟用路徑規劃模式
   - 在地圖上點擊多個位置
   - 驗證路徑點正確添加和編號

2. **互斥模式測試**

   - 啟用路徑規劃模式後啟用其他模式
   - 驗證路徑規劃模式自動關閉
   - 反向測試其他模式的互斥

3. **完成按鈕測試**
   - 添加多個路徑點後點擊完成
   - 驗證模式正確關閉
   - 檢查控制台輸出統計信息

### 邊界測試

- 無路徑點時點擊完成按鈕
- 只有一個路徑點時點擊完成
- 添加大量路徑點的性能測試

### UI測試

- 按鈕狀態切換正確性
- 地圖游標樣式變化
- 路徑點圖標顯示效果

## 📊 數據結構

### 路徑規劃點 GeoJSON 結構

```json
{
  "type": "Feature",
  "geometry": {
    "type": "Point",
    "coordinates": [121.5654, 25.033]
  },
  "properties": {
    "id": "route_point_1234567890_abc123",
    "layerId": "route-planning-layer",
    "type": "route-planning-point",
    "name": "路徑點 1",
    "order": 1,
    "latitude": 25.033,
    "longitude": 121.5654,
    "createdAt": "2024-01-15T10:30:00.000Z"
  }
}
```

### 圖層統計數據結構

```json
{
  "totalCount": 3,
  "type": "路徑規劃點",
  "description": "共 3 個路徑規劃點，點選完成後可進行路徑規劃",
  "lastUpdated": "2024-01-15T10:35:00.000Z",
  "coverage": "3 個路徑點"
}
```

### 表格數據結構

```json
[
  {
    "#": 1,
    "名稱": "路徑點 1",
    "類型": "路徑規劃點",
    "緯度": "25.033000",
    "經度": "121.565400",
    "建立時間": "2024/1/15 上午10:30:00",
    "順序": 1
  }
]
```

## 🚀 擴展性設計

### 未來可擴展功能

1. **路徑規劃API整合**

   - 整合 OpenRouteService 路線規劃API
   - 顯示最佳路線和預估時間
   - 支援不同交通方式（開車、步行、騎車）

2. **路線視覺化**

   - 在地圖上繪製路線
   - 顯示路線長度和預估時間
   - 支援多種路線選項

3. **路徑點管理**

   - 拖拽調整路徑點順序
   - 路徑點之間插入新點
   - 批量導入/導出路徑點

4. **高級路線功能**
   - 避開特定區域
   - 優先經過特定地點
   - 多目標點最佳化排序

### 技術架構優勢

- **模組化設計**: 路徑規劃功能完全獨立
- **一致的API**: 與其他分析圖層保持相同的介面風格
- **可擴展性**: 易於添加新的路徑規劃功能
- **維護性**: 清晰的代碼結構和詳細的註釋

---

_此實現為長照資訊系統提供了完整的路徑規劃基礎功能，為後續的進階路線規劃功能奠定了堅實的基礎。_
