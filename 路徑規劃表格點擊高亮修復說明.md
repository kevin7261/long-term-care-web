# 路徑規劃表格點擊高亮修復說明

## 🐛 問題描述

用戶反映：**點擊路徑規劃圖層清單還是 rightpane 還是沒出現？**

### 問題分析

1. **表格點擊事件**：DataTableTab 中的 `handleHighlight` 函數正常觸發
2. **事件傳遞**：事件正確傳遞到 HomeView → MiddleView → UpperView → MapTab
3. **高亮邏輯**：MapTab 中的 `highlightFeature` 函數正常執行
4. **根本問題**：路徑規劃圖層的表格數據 (`tableData`) 中缺少正確的 `id` 字段

### 問題根源

```javascript
// 🚫 問題：表格數據只有序號 '#'，沒有對應的 feature ID
tableData.push({
  '#': index + 1, // ❌ 只有序號，不是 feature ID
  名稱: route.properties.name,
  // ... 其他屬性
});

// 🚫 問題：DataTableTab 使用錯誤的 ID
const highlightData = {
  id: item['#'], // ❌ 使用序號作為 ID，無法找到對應的 feature
  layerId: layer.layerId,
  // ...
};
```

## 🔧 修復方案

### 1. 修復表格數據結構 ✅

#### **修復 `updateRoutePlanningLayerData` 函數**

**修復前**：

```javascript
// 添加已完成的路線
completedRoutes.forEach((route, index) => {
  tableData.push({
    '#': index + 1, // ❌ 只有序號
    名稱: route.properties.name,
    // ... 其他屬性
  });
});
```

**修復後**：

```javascript
// 添加已完成的路線
completedRoutes.forEach((route, index) => {
  tableData.push({
    '#': index + 1,
    id: route.properties.id, // ✅ 添加正確的 feature ID 用於高亮顯示
    名稱: route.properties.name,
    // ... 其他屬性
  });
});
```

#### **修復規劃中路線的 ID**

**修復前**：

```javascript
// 如果有正在規劃的路徑點，添加到表格
if (currentRoutePoints.length > 0) {
  tableData.push({
    '#': completedRoutes.length + 1, // ❌ 只有序號
    名稱: `路線 ${completedRoutes.length + 1}`,
    // ... 其他屬性
  });
}
```

**修復後**：

```javascript
// 如果有正在規劃的路徑點，添加到表格
if (currentRoutePoints.length > 0) {
  const firstPoint = currentRoutePoints[0];

  tableData.push({
    '#': completedRoutes.length + 1,
    id: firstPoint.properties.id, // ✅ 使用第一個路徑點的 ID 作為規劃中路線的代表
    名稱: `路線 ${completedRoutes.length + 1}`,
    // ... 其他屬性
  });
}
```

### 2. 修復點擊事件處理 ✅

#### **修復 DataTableTab 中的 `handleHighlight` 函數**

**修復前**：

```javascript
const highlightData = {
  id: item['#'], // ❌ 使用序號，無法找到 feature
  layerId: layer.layerId,
  // ...
};
```

**修復後**：

```javascript
const highlightData = {
  id: item.id || item['#'], // ✅ 優先使用 item.id，如果沒有則使用 item['#'] 作為後備
  layerId: layer.layerId,
  // ...
};
```

## 📊 數據結構對比

### 修復前的表格數據

```javascript
[
  {
    '#': 1, // ❌ 只有序號
    名稱: '路線 1',
    類型: '已完成路線',
    // ... 其他屬性
  },
  {
    '#': 2, // ❌ 只有序號
    名稱: '路線 2',
    類型: '規劃中',
    // ... 其他屬性
  },
];
```

### 修復後的表格數據

```javascript
[
  {
    '#': 1,
    id: 'route_1640995200000_abc123', // ✅ 正確的 feature ID
    名稱: '路線 1',
    類型: '已完成路線',
    // ... 其他屬性
  },
  {
    '#': 2,
    id: 'route_point_1640995200000_def456', // ✅ 規劃中路線使用第一個路徑點的 ID
    名稱: '路線 2',
    類型: '規劃中',
    // ... 其他屬性
  },
];
```

## 🔄 事件流程

### 修復後的完整事件流程

```
1. 用戶點擊表格行
   ↓
2. DataTableTab.handleHighlight()
   ├─ id: item.id (正確的 feature ID) ✅
   ├─ layerId: 'route-planning-layer'
   └─ emit('highlight-on-map', highlightData)
   ↓
3. HomeView.handleHighlight()
   └─ 切換到地圖視圖
   ↓
4. MiddleView.highlightFeature()
   └─ 傳遞到 UpperView
   ↓
5. UpperView.highlightFeature()
   └─ 傳遞到 MapTab
   ↓
6. MapTab.highlightFeature()
   ├─ 在 'route-planning-layer' 中搜尋 feature ID ✅
   ├─ 找到對應的 feature ✅
   ├─ dataStore.setSelectedFeature(feature) ✅
   └─ 應用高亮樣式 ✅
   ↓
7. PropertiesTab 自動顯示詳細信息 ✅
```

## 🎯 修復效果

### ✅ 已完成路線點擊

```
點擊表格中的 "路線 1" →
├─ 🔍 搜尋: layerId="route-planning-layer", featureId="route_1640995200000_abc123"
├─ ✅ 找到: 橘色路線 feature
├─ 🎯 高亮: 路線變為白色邊框，增加粗細
├─ 📋 選中: dataStore.selectedFeature = routeFeature
└─ 📄 顯示: PropertiesTab 顯示路線詳細信息
```

### ✅ 規劃中路線點擊

```
點擊表格中的 "路線 2 (規劃中)" →
├─ 🔍 搜尋: layerId="route-planning-layer", featureId="route_point_1640995200000_def456"
├─ ✅ 找到: 第一個路徑點 feature
├─ 🎯 高亮: 路徑點圖標放大 1.6 倍
├─ 📋 選中: dataStore.selectedFeature = pointFeature
└─ 📄 顯示: PropertiesTab 顯示路徑點詳細信息
```

## 🧪 測試方法

### 測試步驟

1. **創建路線**：

   ```
   1. 點擊 "點選路徑規劃點"
   2. 在地圖上點擊 3 個點
   3. 點擊 "路徑規劃點選完成"
   4. 確認生成 "路線 1"
   ```

2. **測試已完成路線**：

   ```
   1. 切換到 "資料表格" 分頁
   2. 點擊路徑規劃圖層的 "路線 1" 行
   3. ✅ 確認地圖上橘色路線被高亮顯示
   4. ✅ 確認右側面板顯示路線詳細信息
   ```

3. **測試規劃中路線**：
   ```
   1. 再次點擊 "點選路徑規劃點"
   2. 在地圖上點擊 2 個點（不完成）
   3. 切換到 "資料表格" 分頁
   4. 點擊 "路線 2 (規劃中)" 行
   5. ✅ 確認地圖上第一個路徑點被高亮顯示
   6. ✅ 確認右側面板顯示路徑點詳細信息
   ```

## 📋 檢查清單

### ✅ 修復完成項目

- ✅ **表格數據結構**：為每個表格項目添加正確的 `id` 字段
- ✅ **已完成路線**：使用 `route.properties.id` 作為表格項目的 `id`
- ✅ **規劃中路線**：使用第一個路徑點的 `id` 作為表格項目的 `id`
- ✅ **點擊事件處理**：優先使用 `item.id`，後備使用 `item['#']`
- ✅ **事件傳遞鏈**：從 DataTableTab → HomeView → MapTab 的完整鏈路
- ✅ **高亮邏輯**：MapTab 中的 feature 搜尋和高亮應用
- ✅ **選中狀態**：正確設置 `dataStore.selectedFeature`
- ✅ **詳細顯示**：PropertiesTab 自動顯示對應的詳細信息

### 🔄 自動處理項目

- 🔄 **向後兼容**：對於沒有 `id` 字段的其他圖層，仍使用 `item['#']` 作為後備
- 🔄 **錯誤處理**：如果找不到對應的 feature，會在 console 中輸出診斷信息
- 🔄 **響應式設計**：桌面版和移動版都能正常工作

## 🎉 預期結果

修復後，用戶點擊路徑規劃圖層清單的任何項目時：

1. **🗺️ 地圖響應**：自動切換到地圖視圖
2. **🎯 高亮顯示**：對應的路線或路徑點在地圖上被高亮顯示
3. **📄 詳細信息**：右側面板 (PropertiesTab) 自動顯示詳細信息
4. **📊 完整數據**：包括經緯度、屬性、關聯路徑點等所有信息

---

_現在點擊路徑規劃圖層清單的項目應該能夠正確觸發高亮顯示和右側面板的詳細信息顯示了！_
