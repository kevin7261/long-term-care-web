# 路徑規劃點保留修正說明

## 🎯 問題描述

用戶反映「規劃點還是沒有留在地圖上」，原因是之前的實現會在路徑規劃完成後清空所有路徑規劃點，導致用戶無法看到已完成路線的路徑點。

## 🔧 修正方案

### 核心概念：路徑點狀態管理

將路徒規劃點分為兩種狀態：

- **規劃中** (`status` 未設置或不等於 `'completed'`)：橘色顯示，可以繼續編輯
- **已完成** (`status === 'completed'`)：灰色顯示，關聯到特定路線

## 📝 具體修正內容

### 1. 修改路線完成邏輯 ✅

**修正前：清空路徑點**

```javascript
// 🔥 關鍵修改：清除當前的路徑規劃點，準備下一次規劃
routePlanningLayer.geoJsonData.features =
  routePlanningLayer.geoJsonData.features.filter(
    (f) => f.properties.type !== 'route-planning-point'
  );
```

**修正後：標記為已完成**

```javascript
// 🔥 修改：將當前路徑規劃點標記為已完成，但保留在地圖上
routePlanningLayer.geoJsonData.features.forEach((feature) => {
  if (feature.properties.type === 'route-planning-point') {
    // 將路徑點標記為已完成，關聯到對應的路線
    feature.properties.status = 'completed';
    feature.properties.routeId = routeId;
    feature.properties.routeNumber = routeNumber;
  }
});
```

### 2. 修改數據過濾邏輯 ✅

所有涉及路徑點計算的函數都需要區分狀態：

#### `updateRoutePlanningLayerData`

```javascript
// 獲取當前正在規劃的路徑點（排除已完成的）
const currentRoutePoints = routePlanningLayer.geoJsonData.features.filter(
  (f) =>
    f.properties.type === 'route-planning-point' &&
    f.properties.status !== 'completed'
);
```

#### `addRoutePlanningPoint`

```javascript
// 計算當前正在規劃的路徑點數量，用於生成順序編號（排除已完成的）
const currentPoints = routePlanningLayer.geoJsonData.features.filter(
  (f) =>
    f.properties.type === 'route-planning-point' &&
    f.properties.status !== 'completed'
);
```

#### `getRoutePlanningCoordinates`

```javascript
// 獲取正在規劃中的路徑規劃點，並按順序排序（排除已完成的）
const routePoints = routePlanningLayer.geoJsonData.features
  .filter(
    (f) =>
      f.properties.type === 'route-planning-point' &&
      f.properties.status !== 'completed'
  )
  .sort((a, b) => a.properties.order - b.properties.order);
```

### 3. 視覺樣式區分 ✅

#### 路徑點圖標樣式

**正在規劃中的路徑點**：

```javascript
// 橘色背景，白色文字，白色邊框
const backgroundColor = 'var(--my-color-orange)';
const borderColor = 'white';
const textColor = 'var(--my-color-white)';
```

**已完成的路徑點**：

```javascript
// 灰色背景，淺灰色文字，灰色邊框
const backgroundColor = 'var(--my-color-gray-500)';
const borderColor = 'var(--my-color-gray-400)';
const textColor = 'var(--my-color-gray-200)';
```

#### 動態樣式應用

```javascript
const isCompleted = feature.properties.status === 'completed';

// 根據完成狀態選擇不同的樣式
const backgroundColor = isCompleted
  ? 'var(--my-color-gray-500)'
  : 'var(--my-color-orange)';
const borderColor = isCompleted ? 'var(--my-color-gray-400)' : 'white';
const textColor = isCompleted
  ? 'var(--my-color-gray-200)'
  : 'var(--my-color-white)';
```

### 4. 彈出視窗增強 ✅

#### 已完成路徑點的彈出視窗

```html
<div class="">
  <div class="my-title-xs-gray pb-2">路徑規劃圖層</div>
  <div class="my-content-sm-black">路徑點 1</div>
  <div class="my-content-xs-gray pt-1">順序: 1</div>
  <div class="my-content-xs-gray">所屬路線: 路線 1</div>
  <div class="my-content-xs-gray">狀態: 已完成</div>
</div>
```

#### 規劃中路徑點的彈出視窗

```html
<div class="">
  <div class="my-title-xs-gray pb-2">路徑規劃圖層</div>
  <div class="my-content-sm-black">路徑點 1</div>
  <div class="my-content-xs-gray pt-1">順序: 1</div>
  <div class="my-content-xs-gray">狀態: 規劃中</div>
</div>
```

### 5. 清空功能優化 ✅

#### 修改 `clearRoutePlanningLayer` 函數

```javascript
const clearRoutePlanningLayer = (clearAll = false) => {
  const routePlanningLayer = findLayerById('route-planning-layer');
  if (routePlanningLayer) {
    if (clearAll) {
      // 清空所有內容（路徑點 + 路線）
      routePlanningLayer.geoJsonData.features = [];
    } else {
      // 只清空正在規劃的路徑點，保留已完成的路線和路徑點
      routePlanningLayer.geoJsonData.features =
        routePlanningLayer.geoJsonData.features.filter(
          (f) =>
            f.properties.type !== 'route-planning-point' ||
            f.properties.status === 'completed'
        );
    }
    updateRoutePlanningLayerData(routePlanningLayer);
  }
};
```

## 🎨 視覺效果

### 路徑點狀態對比

| 狀態   | 背景色  | 文字色  | 邊框色  | 說明                 |
| ------ | ------- | ------- | ------- | -------------------- |
| 規劃中 | 🟠 橘色 | ⚪ 白色 | ⚪ 白色 | 當前正在規劃的路徑點 |
| 已完成 | 🔘 灰色 | 🔘 淺灰 | 🔘 深灰 | 已完成路線的路徑點   |

### 地圖顯示效果

```
路線 1 (已完成):
🔘1 ────🔘2 ────🔘3 ────🔘4  (灰色路徑點 + 橘色路線)

路線 2 (規劃中):
🟠1 ────🟠2                    (橘色路徑點，尚無路線)
```

## 🔄 工作流程

### 完整的多路線規劃流程

```
1. 開始第一條路線規劃
   點擊「點選路徑規劃點」→ 地圖點擊 → 顯示 🟠1, 🟠2, 🟠3

2. 完成第一條路線
   點擊「路徑規劃點選完成」→ 顯示橘色路線 → 路徑點變成 🔘1, 🔘2, 🔘3

3. 開始第二條路線規劃
   再次點擊「點選路徑規劃點」→ 地圖點擊 → 顯示 🟠1, 🟠2
   (新的路徑點編號重新從1開始，與已完成的路徑點共存)

4. 完成第二條路線
   點擊「路徑規劃點選完成」→ 顯示第二條橘色路線 → 新路徑點也變成灰色

最終結果：
- 地圖上同時顯示兩條橘色路線
- 所有路徑點都保留在地圖上，以灰色顯示
- 每個路徑點都記錄了所屬的路線編號
```

## 📊 數據結構

### 路徑點數據結構

#### 規劃中的路徑點

```javascript
{
  type: 'Feature',
  geometry: { type: 'Point', coordinates: [lng, lat] },
  properties: {
    id: 'route_point_1640995200000_abc123',
    layerId: 'route-planning-layer',
    type: 'route-planning-point',
    name: '路徑點 1',
    order: 1,
    // status 未設置，表示規劃中
    createdAt: '2024-01-15T10:30:00.000Z'
  }
}
```

#### 已完成的路徑點

```javascript
{
  type: 'Feature',
  geometry: { type: 'Point', coordinates: [lng, lat] },
  properties: {
    id: 'route_point_1640995200000_abc123',
    layerId: 'route-planning-layer',
    type: 'route-planning-point',
    name: '路徑點 1',
    order: 1,
    status: 'completed',        // ← 標記為已完成
    routeId: 'route_1640995260000_def456',  // ← 關聯的路線ID
    routeNumber: 1,             // ← 所屬路線編號
    createdAt: '2024-01-15T10:30:00.000Z'
  }
}
```

## ✅ 修正效果

### 修正前的問題

- ❌ 路徑規劃完成後路徑點消失
- ❌ 無法看到歷史路線的路徑點
- ❌ 路徑點與路線沒有關聯

### 修正後的效果

- ✅ 路徑點永久保留在地圖上
- ✅ 已完成的路徑點以灰色顯示
- ✅ 正在規劃的路徑點以橘色顯示
- ✅ 路徑點與路線有明確的關聯關係
- ✅ 彈出視窗顯示路徑點的詳細狀態
- ✅ 支持多條路線的路徑點同時顯示

## 🚀 測試驗證

### 測試步驟

1. **第一條路線**：

   - 點選 3 個路徑點 → 確認顯示 🟠1, 🟠2, 🟠3
   - 完成規劃 → 確認路徑點變成 🔘1, 🔘2, 🔘3 且保留在地圖上

2. **第二條路線**：

   - 再次開始規劃 → 點選 2 個路徑點 → 確認顯示 🟠1, 🟠2
   - 完成規劃 → 確認新路徑點也變成灰色

3. **最終檢查**：
   - 地圖上同時顯示兩條橘色路線
   - 所有路徑點都以灰色保留在地圖上
   - 點擊路徑點查看彈出視窗，確認狀態和所屬路線信息正確

---

_現在路徑規劃點會永久保留在地圖上，已完成的路徑點以灰色顯示，正在規劃的路徑點以橘色顯示，提供完整的路徑規劃歷史記錄。_
