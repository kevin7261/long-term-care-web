# 點擊模式互斥功能實現說明

## 🎯 功能需求

用戶要求「點選數據分析位置」和「點選等時圈分析位置」兩個模式互斥，同時只能開啟一個，當開啟一個模式時，另一個模式應該自動關閉。

## 🔍 問題分析

### 原有行為

- 用戶可以同時開啟兩種點擊模式
- 兩個模式同時啟用會造成混淆
- 用戶體驗不佳，不清楚當前處於哪種分析模式

### 需要的行為

- 兩種點擊模式互斥
- 開啟一個模式時，自動關閉另一個模式
- 確保同一時間只有一種分析模式啟用

## 🛠️ 實現方案

### 修改 startClickMode 函數

```javascript
// 開始點擊模式
const startClickMode = () => {
  // 🔄 互斥邏輯：關閉等時圈點擊模式
  if (isIsochroneClickMode.value) {
    stopIsochroneClickMode();
  }

  isClickMode.value = true;
  if (mapInstance) {
    const mapContainer = mapInstance.getContainer();
    mapContainer.style.cursor = 'crosshair';
    // 為所有子元素設定十字游標
    mapContainer.classList.add('click-mode-active');
  }
  console.log('🖱️ 開始數據分析點擊模式（自動關閉等時圈分析模式）');
};
```

### 修改 startIsochroneClickMode 函數

```javascript
// 開始等時圈點擊模式
const startIsochroneClickMode = () => {
  // 🔄 互斥邏輯：關閉數據分析點擊模式
  if (isClickMode.value) {
    stopClickMode();
  }

  isIsochroneClickMode.value = true;
  if (mapInstance) {
    const mapContainer = mapInstance.getContainer();
    mapContainer.style.cursor = 'crosshair';
    // 為所有子元素設定十字游標
    mapContainer.classList.add('isochrone-click-mode-active');
  }
  console.log('🖱️ 開始等時圈分析點擊模式（自動關閉數據分析模式）');
};
```

## 🎯 實現效果

### 修改前

- ❌ 可以同時開啟兩種點擊模式
- ❌ 用戶不清楚當前處於哪種模式
- ❌ 點擊行為可能產生混淆

### 修改後

- ✅ 兩種點擊模式互斥
- ✅ 開啟一個模式時自動關閉另一個
- ✅ 用戶界面更清晰，避免混淆
- ✅ 控制台日誌明確顯示模式切換

## 🔄 互斥邏輯流程

### 情況 1：從數據分析模式切換到等時圈分析模式

```
用戶狀態：數據分析點擊模式已啟用
用戶操作：點擊「點選等時圈分析位置」按鈕

系統執行：
1. startIsochroneClickMode() 被調用
2. 檢測到 isClickMode.value = true
3. 自動調用 stopClickMode()
4. 關閉數據分析模式的 UI 狀態
5. 啟用等時圈分析模式
6. 更新地圖游標和樣式

結果：成功切換到等時圈分析模式
```

### 情況 2：從等時圈分析模式切換到數據分析模式

```
用戶狀態：等時圈分析點擊模式已啟用
用戶操作：點擊「點選數據分析位置」按鈕

系統執行：
1. startClickMode() 被調用
2. 檢測到 isIsochroneClickMode.value = true
3. 自動調用 stopIsochroneClickMode()
4. 關閉等時圈分析模式的 UI 狀態
5. 啟用數據分析模式
6. 更新地圖游標和樣式

結果：成功切換到數據分析模式
```

## 🎨 UI 狀態管理

### 按鈕狀態變化

**數據分析按鈕：**

- 未啟用：顯示「點選數據分析位置」
- 已啟用：顯示「取消數據分析點選」（紅色）

**等時圈分析按鈕：**

- 未啟用：顯示「點選等時分析位置」
- 已啟用：顯示「取消等時圈點選」（紅色）

### 地圖游標樣式

**數據分析模式：**

- 游標：crosshair
- CSS 類別：`click-mode-active`

**等時圈分析模式：**

- 游標：crosshair
- CSS 類別：`isochrone-click-mode-active`

### 控制台日誌

**啟用數據分析模式：**

```
🖱️ 開始數據分析點擊模式（自動關閉等時圈分析模式）
```

**啟用等時圈分析模式：**

```
🖱️ 開始等時圈分析點擊模式（自動關閉數據分析模式）
```

## 🧪 測試場景

### 測試場景 1：基本互斥功能

1. 點擊「點選數據分析位置」按鈕
2. 驗證按鈕變為「取消數據分析點選」
3. 點擊「點選等時分析位置」按鈕
4. 驗證數據分析按鈕自動恢復為「點選數據分析位置」
5. 驗證等時圈分析按鈕變為「取消等時圈點選」

### 測試場景 2：反向切換

1. 點擊「點選等時分析位置」按鈕
2. 驗證按鈕變為「取消等時圈點選」
3. 點擊「點選數據分析位置」按鈕
4. 驗證等時圈分析按鈕自動恢復為「點選等時分析位置」
5. 驗證數據分析按鈕變為「取消數據分析點選」

### 測試場景 3：取消按鈕功能

1. 啟用任一分析模式
2. 點擊對應的「取消」按鈕
3. 驗證模式正確關閉
4. 驗證地圖游標恢復正常

## 📝 開發者注意事項

### 代碼維護

- 互斥邏輯集中在啟動函數中
- 停止函數保持獨立，不包含互斥邏輯
- 控制台日誌幫助調試和監控

### 性能考量

- 互斥檢查的開銷很小
- 不會影響地圖操作性能
- 狀態變更是即時的

### 擴展性

- 如果未來添加更多分析模式，可以擴展互斥邏輯
- 可以考慮創建統一的模式管理器
- 當前實現簡單有效，易於理解

## 🔧 技術實現細節

### 狀態檢查邏輯

```javascript
// 檢查另一個模式是否啟用
if (isIsochroneClickMode.value) {
  stopIsochroneClickMode(); // 關閉另一個模式
}
```

### UI 清理邏輯

```javascript
// 完整的模式關閉包括：
// 1. 設置狀態為 false
// 2. 恢復地圖游標
// 3. 移除 CSS 類別
// 4. 記錄日誌
```

### 事件處理順序

```
1. 用戶點擊按鈕
2. 檢查並關閉互斥模式
3. 啟用新模式
4. 更新 UI 狀態
5. 記錄操作日誌
```

---

_此實現確保兩種分析模式的互斥操作，提供清晰一致的用戶體驗。_
